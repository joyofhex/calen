#!/usr/bin/env ruby

require 'logging'
require 'yaml'
require 'time'
require 'optparse'
require 'pry'
require 'chronic_duration'

require 'calen/app/dayview'

require 'date_ranges'
require 'exchange_gateway'
require 'options'

logger = Logging.logger(STDOUT)
logger.level = :warn

option_parser = Options.new
options = option_parser.parse(ARGV)

endpoint = 'https://webmail.tomtomgroup.com/ews/Exchange.asmx'
settings = YAML.load_file File.expand_path('~/.jira')

ex = ExchangeGateway.new(endpoint, settings)

def time_iterate(start_time, end_time, step, &block)
  begin
    yield(start_time)
  end while (start_time += step) <= end_time
end

def is_time_covered_by_booked_times?(booked_ranges, time)
  !!booked_ranges.detect { |b| b.cover? time }
end

def free_symbol(time)
  time.to_i % 3600 == 0 ? '|' : '.'
end

def free_busy_per_quarter_hour_display(booked_ranges, start_time, end_time)
  display_string = ''
  time_iterate(start_time, end_time, 900) do |time|
    display_string += is_time_covered_by_booked_times?(booked_ranges, time) ? '*' : free_symbol(time)
  end
  display_string
end

def time_header(start_time, end_time, step)
  display_string = ''
  time_iterate(start_time, end_time, 7200) do |time|
    display_string += '|%-7s' % [time.strftime('%H:%M')]
  end
  display_string
end

rooms = ex.rooms_in_site_code(options.sites.first)
today = options.date

if options.mode == :dayview
  app = Calen::App::Dayview.new
  app.run(options, ex, rooms)
elsif options.mode == :freerooms
  start_time = options.time
  end_time = options.time + options.length

  rooms.each do |room|
    room[:booked] = ex.room_availability room[:address], start_time, end_time
  end

  puts 'Available rooms on %s at %s for %s (ending at %s)' % [
    start_time.strftime('%F'),
    start_time.strftime('%R'),
    ChronicDuration.output(options.length),
    end_time.strftime('%R'),
  ]

  rooms.each do |room|
    puts "\t" + room[:name] if room[:booked].length == 0
  end
end


