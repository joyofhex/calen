#!/usr/bin/env ruby

require 'logging'
require 'yaml'
require 'time'
require 'optparse'
require 'pry'
require 'chronic_duration'

require 'calen/app/dayview'
require 'calen/app/freerooms'

require 'date_ranges'
require 'exchange_gateway'
require 'options'

logger = Logging.logger(STDOUT)
logger.level = :warn

option_parser = Options.new
options = option_parser.parse(ARGV)

endpoint = 'https://webmail.tomtomgroup.com/ews/Exchange.asmx'
settings = YAML.load_file File.expand_path('~/.jira')

ex = ExchangeGateway.new(endpoint, settings)

rooms = ex.rooms_in_site_code(options.sites.first)
today = options.date

if options.mode == :dayview
  app = Calen::App::Dayview.new
  app.run(options, ex, rooms)
elsif options.mode == :freerooms
  start_time = options.time
  end_time = options.time + options.length

  rooms.each do |room|
    room[:booked] = ex.room_availability room[:address], start_time, end_time
  end

  puts 'Available rooms on %s at %s for %s (ending at %s)' % [
    start_time.strftime('%F'),
    start_time.strftime('%R'),
    ChronicDuration.output(options.length),
    end_time.strftime('%R'),
  ]

  rooms.each do |room|
    puts "\t" + room[:name] if room[:booked].length == 0
  end
end


